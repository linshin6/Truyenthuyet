<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trò Chơi Sắp Xếp Truyền Thuyết (Thẻ tự thu nhỏ)</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện Tone.js để tạo âm thanh -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Tùy chỉnh font cho phù hợp với tiếng Việt */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        /* Tạo kiểu cho thẻ kéo (KÍCH THƯỚC GỐC) */
        .draggable-card {
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s, font-size 0.2s, padding 0.2s;
            position: relative; /* Quan trọng để định vị icon */
        }
        .draggable-card:active {
            cursor: grabbing;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
            z-index: 100;
        }
        /* Tạo kiểu cho khu vực thả */
        .dropzone {
            border: 3px dashed #d1d5db; /* border-gray-300 */
            min-height: 250px; 
            transition: background-color 0.3s, border-color 0.3s;
        }
        /* Hiệu ứng khi kéo qua khu vực thả */
        .drag-over {
            background-color: #f3f4f6; /* bg-gray-100 */
            border-color: #3b82f6; /* blue-500 */
        }
        
        /* Icon kết quả (KÍCH THƯỚC GỐC cho thẻ nguồn) */
        .result-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.25rem; /* text-xl */
            line-height: 1;
        }
        
        /* === THAY ĐỔI QUAN TRỌNG === */
        /* Chỉ thu nhỏ thẻ KHI NẰM TRONG KHUNG THẢ */
        .dropzone .draggable-card {
            font-size: 0.75rem; /* text-xs */
            padding: 0.5rem;    /* p-2 */
            line-height: 1.3;   /* Thêm khoảng cách dòng */
            
            /* Ghi đè các lớp cuộn ngang */
            flex-shrink: 1; /* Cho phép co lại */
            width: 100%;    /* Chiếm 100% chiều rộng của cột */
            /* Các lớp 'w-60', 'sm:w-64' sẽ bị ghi đè bởi 'width: 100%' */
        }

        /* Điều chỉnh icon cho thẻ đã thu nhỏ BÊN TRONG KHUNG */
        .dropzone .result-icon {
            font-size: 1rem; /* text-base */
            top: 3px;
            right: 3px;
        }
        /* === KẾT THÚC THAY ĐỔI === */


        .correct-icon {
            color: #10b981; /* emerald-500 */
        }
        .incorrect-icon {
            color: #ef4444; /* red-500 */
        }

        /* Thẻ đã được sắp xếp đúng */
        .correct-card-style {
            border-left: 5px solid #10b981; /* emerald-500 */
            opacity: 0.95;
            cursor: default;
        }
        /* Thẻ đã được sắp xếp sai */
        .incorrect-card-style {
            border-left: 5px solid #ef4444; /* red-500 */
            opacity: 0.95;
        }
        /* Hiệu ứng rung lắc cho thẻ sai */
        @keyframes shake {
            0% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        /* Cải thiện thanh cuộn ngang trên di động */
        #card-container::-webkit-scrollbar {
            height: 8px;
        }
        #card-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #card-container::-webkit-scrollbar-thumb {
            background: #d1d5db; /* border-gray-300 */
            border-radius: 10px;
        }
        #card-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; /* border-gray-400 */
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col items-center p-0 sm:p-8">
    
    <div class="max-w-7xl w-full">
        <!-- Tiêu đề và Mô tả -->
        <header class="text-center mb-6 md:mb-8 px-4 pt-6 md:pt-0">
            <h1 class="text-3xl sm:text-5xl font-extrabold text-blue-800 tracking-tight">
                Trò Chơi Sắp Xếp Truyền Thuyết
            </h1>
            <p class="mt-2 text-base sm:text-lg text-gray-600">
                Hãy kéo và thả các thẻ thông tin dưới đây vào nhóm truyền thuyết phù hợp.
            </p>
        </header>

        <!-- Khu vực Thẻ để Kéo (Nguồn) - Dính (Sticky) -->
        <section id="card-source" class="mb-6 p-4 sm:p-6 bg-white shadow-xl rounded-b-2xl md:rounded-2xl border-b md:border border-gray-100 sticky top-0 z-20 md:static">
            <h2 class="text-lg sm:text-xl font-semibold mb-4 text-blue-700 hidden md:block">
                Các Thẻ Thông Tin (Kéo từ đây)
            </h2>
            <!-- Cuộn ngang trên di động, lưới trên desktop -->
            <div id="card-container" class="flex overflow-x-auto whitespace-nowrap p-2 -m-2 gap-4 md:grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 md:overflow-visible md:whitespace-normal">
                <!-- Thẻ sẽ được tạo bằng JavaScript -->
            </div>
        </section>

        <!-- Khu vực chính, thêm padding cho di động -->
        <main class="px-2 sm:px-0">
            <!-- Khu vực Thả (Đích) - 2 cột -->
            <section id="drop-targets" class="grid grid-cols-2 gap-2 sm:gap-4 md:gap-6">
                <!-- Khu vực Thả 1: Con Rồng cháu Tiên -->
                <div class="dropzone p-2 sm:p-4 rounded-xl shadow-lg bg-yellow-50 flex flex-col" data-legend="CRCT">
                    <h2 class="text-lg sm:text-2xl font-bold mb-2 text-yellow-700 border-b pb-1 sm:pb-2 border-yellow-200">
                        <span class="text-2xl sm:text-3xl mr-1 sm:mr-2">🐉</span> Con Rồng cháu Tiên
                    </h2>
                    <div id="drop-crct" class="space-y-2 sm:space-y-3 flex-grow min-h-20">
                        <!-- Thẻ được thả vào đây -->
                    </div>
                </div>

                <!-- Khu vực Thả 2: Thánh Gióng -->
                <div class="dropzone p-2 sm:p-4 rounded-xl shadow-lg bg-green-50 flex flex-col" data-legend="TG">
                    <h2 class="text-lg sm:text-2xl font-bold mb-2 text-green-700 border-b pb-1 sm:pb-2 border-green-200">
                        <span class="text-2xl sm:text-3xl mr-1 sm:mr-2">🐎</span> Thánh Gióng
                    </h2>
                    <div id="drop-tg" class="space-y-2 sm:space-y-3 flex-grow min-h-20">
                        <!-- Thẻ được thả vào đây -->
                    </div>
                </div>
            </section>

            <!-- Nút kiểm tra và chơi lại -->
            <div class="mt-10 mb-8 flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="check-button" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 w-full sm:w-auto">
                    Xem Tổng Kết Quả
                </button>
                <button id="reset-button" class="px-8 py-3 bg-gray-300 text-gray-800 font-bold rounded-full shadow-md hover:bg-gray-400 transition duration-300 transform hover:scale-105 w-full sm:w-auto">
                    Chơi Lại
                </button>
            </div>
        </main>

        <!-- Hộp thông báo kết quả (Modal) -->
        <div id="result-message" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-sm w-full text-center transform scale-95 transition-all duration-300" id="result-modal-content">
                <h3 id="modal-title" class="text-3xl font-bold mb-4 text-blue-600">Tuyệt vời!</h3>
                <p id="modal-body" class="text-lg text-gray-700 mb-6">Bạn đã sắp xếp đúng tất cả các thẻ!</p>
                <button onclick="document.getElementById('result-message').classList.add('hidden');" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                    Đã Hiểu
                </button>
            </div>
        </div>
    </div>

    <script>
        // Dữ liệu trò chơi
        const gameData = [
            // Con Rồng cháu Tiên (CRCT)
            { id: 'crct-1', content: 'Lí giải về xuất thân của người Việt.', group: 'CRCT' },
            { id: 'crct-2', content: 'Những vị thần cao quý sinh ra một bọc có trăm trứng, nở ra trăm người con.', group: 'CRCT' },
            { id: 'crct-3', content: 'Năm mươi con theo cha về miền biển, mươi con theo mẹ lên núi cao, chia nhau trị vì các nơi.', group: 'CRCT' },
            { id: 'crct-4', content: 'Người con cả lên ngôi vua được gọi là Hùng Vương, đặt tên nước là Văn Lang. Đóng đô ở Phong Châu (Phú Thọ ngày nay).', group: 'CRCT' },
            { id: 'crct-5', content: 'Truyền thuyết nói về thời kì dựng nước của dân tộc ta.', group: 'CRCT' },

            // Thánh Gióng (TG)
            { id: 'tg-1', content: 'Giặc Ân xâm lược nước ta. Vua sai sứ giả đi tìm người tài giúp nước.', group: 'TG' },
            { id: 'tg-2', content: 'Dưới thời Hùng Vương thứ 6, Có một cậu bé ba tuổi vẫn chưa biết khóc, biết cười.', group: 'TG' },
            { id: 'tg-3', content: 'Cậu bé nhờ mẹ gọi sứ giả vào và nhờ chuẩn bị cho một con ngựa sắt, một cái roi sắt và một áo giáp sắt để đánh giặc.', group: 'TG' },
            { id: 'tg-4', content: 'Cậu bé lớn nhanh như thổi, thành một tráng sĩ đánh bại hết quân giặc.', group: 'TG' },
            { id: 'tg-5', content: 'Đánh giặc xong tráng sĩ cưỡi ngựa bay về trời. Mọi người gọi cậu là Phù Đổng Thiên Vương.', group: 'TG' },
            { id: 'tg-6', content: 'Truyền thuyết thể hiện lòng yêu nước và cuộc đấu tranh giữ nước của nhân dân ta.', group: 'TG' },
        ];

        const cardContainer = document.getElementById('card-container');
        const checkButton = document.getElementById('check-button');
        const resetButton = document.getElementById('reset-button');
        const dropZones = document.querySelectorAll('.dropzone');
        const resultMessageModal = document.getElementById('result-message');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const resultModalContent = document.getElementById('result-modal-content');
        
        // Cấu hình âm thanh
        let audioContextInitialized = false;
        let correctSynth, incorrectSynth;

        function initializeAudio() {
             if (audioContextInitialized) return;
            // Khởi tạo Tone.js context (cần tương tác người dùng)
            try {
                Tone.start();
                audioContextInitialized = true;
                
                // Synth cho câu trả lời đúng
                correctSynth = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.1 }
                }).toDestination();

                // Synth cho câu trả lời sai
                incorrectSynth = new Tone.Synth({
                    oscillator: { type: "square" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }
                }).toDestination();

            } catch (e) {
                console.error("Lỗi khi khởi tạo Tone.js:", e);
            }
        }
        
        function playCorrectSound() {
            if (correctSynth) {
                correctSynth.triggerAttackRelease("C5", "8n");
            }
        }

        function playIncorrectSound() {
            if (incorrectSynth) {
                incorrectSynth.triggerAttackRelease("C2", "16n");
            }
        }
        
        // Trạng thái trò chơi
        let cardsPlacedCount = 0; 
        let correctCards = new Set();
        const totalCards = gameData.length;

        // Hàm xáo trộn mảng
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Hàm tạo thẻ kéo
        function createCard(data) {
            const card = document.createElement('div');
            card.id = data.id;
            card.textContent = data.content;
            
            // THAY ĐỔI: Khôi phục kích thước gốc (text-sm, p-3)
            // CSS trong <style> sẽ tự động thu nhỏ thẻ khi nó nằm trong .dropzone
            card.classList.add(
                'draggable-card', 
                'p-3',               // Khôi phục p-3
                'bg-white', 
                'rounded-xl', 
                'shadow-md', 
                'text-sm',           // Khôi phục text-sm
                'text-gray-800', 
                'border', 
                'border-gray-200',
                'hover:shadow-lg',
                'hover:border-blue-300',
                
                // Lớp cho bố cục cuộn ngang
                'flex-shrink-0',     
                'w-60',              
                'sm:w-64',
                'whitespace-normal', 
                'align-top',           
                'md:w-auto'
            );

            card.setAttribute('draggable', true);
            card.setAttribute('data-group', data.group);
            
            // Icon cho thẻ (ban đầu không hiển thị)
            const icon = document.createElement('span');
            icon.classList.add('result-icon', 'hidden');
            card.appendChild(icon);

            // Kéo thẻ
            card.addEventListener('dragstart', (e) => {
                initializeAudio(); 
                if (correctCards.has(e.target.id)) {
                    e.preventDefault(); 
                    return;
                }
                e.dataTransfer.setData('text/plain', e.target.id);
                setTimeout(() => e.target.classList.add('opacity-40'), 0);
            });

            card.addEventListener('dragend', (e) => {
                e.target.classList.remove('opacity-40');
            });

            return card;
        }

        // Hàm cập nhật icon và style cho thẻ
        function updateCardStatus(card, isCorrect) {
            const icon = card.querySelector('.result-icon');
            
            // Xóa các trạng thái cũ
            card.classList.remove('correct-card-style', 'incorrect-card-style', 'shake');
            icon.classList.add('hidden');
            icon.classList.remove('correct-icon', 'incorrect-icon');

            if (isCorrect) {
                card.classList.add('correct-card-style');
                card.classList.remove('hover:shadow-lg', 'hover:border-blue-300');
                icon.textContent = '✔️';
                icon.classList.add('correct-icon');
                icon.classList.remove('hidden');
                card.setAttribute('draggable', false); 
                correctCards.add(card.id);
                playCorrectSound();
            } else {
                card.classList.add('incorrect-card-style', 'shake');
                card.classList.remove('hover:shadow-lg', 'hover:border-blue-300'); 
                icon.textContent = '❌';
                icon.classList.add('incorrect-icon');
                icon.classList.remove('hidden');
                card.setAttribute('draggable', true); 
                correctCards.delete(card.id); 
                playIncorrectSound(); 
            }
            updateCheckButtonState();
        }

        // Hàm khởi tạo trò chơi
        function initializeGame() {
            // Xóa hết thẻ cũ và kết quả
            cardContainer.innerHTML = '';
            document.getElementById('drop-crct').innerHTML = '';
            document.getElementById('drop-tg').innerHTML = '';
            cardsPlacedCount = 0;
            correctCards.clear();

            // Xáo trộn dữ liệu và tạo thẻ
            const shuffledData = shuffleArray([...gameData]); 
            shuffledData.forEach(data => {
                const card = createCard(data);
                cardContainer.appendChild(card);
            });
            
            updateCheckButtonState();

            // Thiết lập trạng thái ban đầu của khu vực thả
            dropZones.forEach(zone => {
                zone.classList.remove('bg-green-100', 'bg-red-100');
            });
        }

        // Hàm gắn sự kiện cho khu vực thả
        function attachDropZoneListeners() {
            dropZones.forEach(zone => {
                // Ngăn chặn hành vi mặc định (cho phép thả)
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });

                // Xóa hiệu ứng khi kéo ra
                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('drag-over');
                });

                // Xử lý khi thả
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');

                    const id = e.dataTransfer.getData('text/plain');
                    const draggableElement = document.getElementById(id);

                    if (draggableElement) {
                        initializeAudio(); 
                        
                        // Thêm thẻ vào khu vực thả
                        zone.querySelector('div').prepend(draggableElement);
                        
                        const targetGroup = zone.getAttribute('data-legend');
                        const cardGroup = draggableElement.getAttribute('data-group');

                        // Cập nhật trạng thái thẻ ngay lập tức
                        updateCardStatus(draggableElement, cardGroup === targetGroup);
                        
                        // Cập nhật số thẻ đã được đặt vào khu vực thả
                        cardsPlacedCount = document.querySelectorAll('.dropzone .draggable-card').length;
                        updateCheckButtonState();
                    }
                });
            });
        }
        
        // Hàm cập nhật trạng thái nút "Xem Tổng Kết Quả"
        function updateCheckButtonState() {
            if (cardsPlacedCount === totalCards) {
                checkButton.disabled = false;
                checkButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                checkButton.disabled = true;
                checkButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // Hàm kiểm tra tổng kết quả (khi nhấn nút)
        function showOverallResult() {
            const correctCount = correctCards.size;
            showResultModal(correctCount, totalCards);
        }

        // Hàm hiển thị modal kết quả
        function showResultModal(correct, total) {
            if (correct === total) {
                // Hoàn hảo
                modalTitle.textContent = "Xin Chúc Mừng!";
                modalTitle.classList.remove('text-red-600', 'text-blue-600');
                modalTitle.classList.add('text-green-600');
                modalBody.innerHTML = `Bạn đã sắp xếp **hoàn hảo**!<br>Tất cả ${total} thẻ đều đúng!`;
            } else if (correct > 0) {
                // Có lỗi sai
                modalTitle.textContent = "Cần Cố Gắng Thêm!";
                modalTitle.classList.remove('text-green-600', 'text-red-600');
                modalTitle.classList.add('text-blue-600');
                modalBody.innerHTML = `Bạn đã sắp xếp đúng **${correct}** thẻ trong tổng số ${total} thẻ.<br>Hãy xem lại các thẻ có dấu **❌** để chỉnh sửa!`;
            } else {
                // Sai hết hoặc chưa làm
                modalTitle.textContent = "Chưa Chính Xác!";
                modalTitle.classList.remove('text-green-600', 'text-blue-600');
                modalTitle.classList.add('text-red-600');
                modalBody.innerHTML = `Bạn đã sắp xếp đúng **${correct}** thẻ.<br>Hãy đọc lại nội dung và thử lại nhé!`;
            }

            resultModalContent.style.transform = 'scale(0.95)'; 
            setTimeout(() => {
                resultMessageModal.classList.remove('hidden');
                resultMessageModal.classList.add('flex');
                resultModalContent.style.transform = 'scale(1)';
            }, 50);
        }

        // Gắn sự kiện nút
        checkButton.addEventListener('click', showOverallResult);
        resetButton.addEventListener('click', initializeGame);

        // Gắn sự kiện kéo-thả MỘT LẦN khi tải trang
        attachDropZoneListeners();

        // Khởi tạo trò chơi lần đầu
        initializeGame();

    </script>
</body>
</html>



